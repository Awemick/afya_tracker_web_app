rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own user documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow providers/admins to read all users for patient connections and management
      allow read: if request.auth != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['provider', 'institution', 'admin']);
    }

    // Users can read and write their own profile data
    match /userProfiles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow authenticated users to read/write appointments they own or are assigned to
    match /appointments/{appointmentId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.doctorId == request.auth.uid ||
         request.auth.uid == resource.data.patientId ||
         request.auth.uid == resource.data.doctorId);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write consultations they own or are assigned to
    match /consultations/{consultationId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.providerId == request.auth.uid ||
         request.auth.uid == resource.data.patientId ||
         request.auth.uid == resource.data.providerId);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write messages in conversations they're part of
    match /messages/{messageId} {
      allow read, write: if request.auth != null &&
        (resource.data.senderId == request.auth.uid ||
         exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
         get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.patientId == request.auth.uid ||
         get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.providerId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write conversations they're part of
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.providerId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write notifications they own
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write medical records they own or are assigned to
    match /medicalRecords/{recordId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.uploadedBy == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write prescriptions they own or are assigned to
    match /prescriptions/{prescriptionId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.doctorId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write progress notes they own or are assigned to
    match /progressNotes/{noteId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.doctorId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write tasks they own or are assigned to
    match /tasks/{taskId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.assignedTo == request.auth.uid ||
         resource.data.createdBy == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write referrals they own or are assigned to
    match /referrals/{referralId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.referringDoctorId == request.auth.uid ||
         resource.data.receivingDoctorId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write patient links they own
    match /patientLinks/{linkId} {
      allow read, write: if request.auth != null && resource.data.patientId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write emergency alerts they own or are assigned to
    match /emergencyAlerts/{alertId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         exists(/databases/$(database)/documents/users/$(resource.data.assignedProviderId)) &&
         resource.data.assignedProviderId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write payment data they own
    match /payments/{paymentId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write payment requests they own
    match /payment_requests/{requestId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write subscriptions they own
    match /subscriptions/{subscriptionId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write commissions they own (as providers)
    match /commissions/{commissionId} {
      allow read, write: if request.auth != null && resource.data.providerId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write emergency premiums they own
    match /emergencyPremiums/{premiumId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.providerId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read analytics data for institutions they belong to
    match /analytics/{analyticId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read reports for institutions they belong to
    match /reports/{reportId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read institution data
    match /institutions/{institutionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Allow authenticated users to read/write staff data for institutions they belong to
    match /staff/{staffId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Allow authenticated users to read doctor availability data
    match /doctorAvailability/{availabilityId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && resource.data.doctorId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read messaging data they own
    match /messaging/{messageId} {
      allow read, write: if request.auth != null &&
        (resource.data.senderId == request.auth.uid ||
         resource.data.recipientId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write kick session data they own
    match /kickSessions/{sessionId} {
      allow read, write: if request.auth != null && resource.data.patientId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write progress notes they own or are assigned to
    match /progressNotes/{noteId} {
      allow read, write: if request.auth != null &&
        (resource.data.patientId == request.auth.uid ||
         resource.data.doctorId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write recommendations they own or are assigned to
    match /recommendations/{recommendationId} {
      allow read, write: if request.auth != null &&
        exists(/databases/$(database)/documents/progressNotes/$(resource.data.noteId)) &&
        (get(/databases/$(database)/documents/progressNotes/$(resource.data.noteId)).data.patientId == request.auth.uid ||
         get(/databases/$(database)/documents/progressNotes/$(resource.data.noteId)).data.doctorId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write reminders they own or are assigned to
    match /reminders/{reminderId} {
      allow read, write: if request.auth != null &&
        exists(/databases/$(database)/documents/tasks/$(resource.data.taskId)) &&
        (get(/databases/$(database)/documents/tasks/$(resource.data.taskId)).data.patientId == request.auth.uid ||
         get(/databases/$(database)/documents/tasks/$(resource.data.taskId)).data.assignedTo == request.auth.uid);
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write payment methods they own
    match /paymentMethods/{methodId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read/write transactions they own
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Allow authenticated users to read payment plans
    match /paymentPlans/{planId} {
      allow read: if request.auth != null;
    }

    // Allow authenticated users to read/write institutions they belong to
    match /institutions/{institutionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Default deny for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}